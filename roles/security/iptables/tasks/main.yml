---
- name: Install netfilters-persistent
  package:
    name: netfilter-persistent
    state: present

# - name: Check if rules.v4 are auto-generated
#   lineinfile:
#     path: /etc/iptables/rules.v4
#     regexp: "^# Generated by iptables-save.*$"
#     state: absent
#   register: autogenerated
#   notify:
#     - remove the default rules

- name: Remove existing rules.v4 
  file:
    path: /etc/iptables/rules.v4
    state: absent

- name: Add a header into rules.v4
  blockinfile:
    create: yes
    mode: 0644
    block: |
      *filter
      :INPUT DROP [0:0]
      :FORWARD DROP [0:0]
      :OUTPUT ACCEPT [0:0]
    path: /etc/iptables/rules.v4

- name: Add iptables rules
  include_tasks: rules.yml

- name: Set the policy for the INPUT chain to DROP
  ansible.builtin.iptables:
    chain: INPUT
    policy: DROP

- name: Save new rules
  shell:
    cmd: iptables -t filter -S INPUT | grep "Ansible managed"
  changed_when: no
  register: iptables_rules

- name: Add COMMIT
  lineinfile:
    line: COMMIT
    state: present
    path: /etc/iptables/rules.v4

- name: Save the new rules into rules.v4
  blockinfile:
    block: "{{ iptables_rules.stdout }}"
    state: present
    insertbefore: COMMIT
    path: /etc/iptables/rules.v4
    marker_begin: "CUSTOM RULES BEGIN"
    marker_end: "CUSTOM RULES END"
  notify:
    - restart relevant services
